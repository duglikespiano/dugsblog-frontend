---
import { getCollection, getEntry, render } from "astro:content";
import RootLayout from "../../../layouts/RootLayout.astro";
import Prose from "../../../layouts/Prose.astro";
import { tags } from "../../../common/types";
import { collectionMap } from "../../../common/types";
import { isStringLanguage } from "../../../common/functions";
import type { Languages, TagKey, TagTranslations } from "../../../common/types";
const { slug } = Astro.params as { slug: string };
const { language } = Astro.params as { language: Languages };
const posts = await getCollection(`${language}Posts`);
const entry = await getEntry(collectionMap[language], slug);
const tagKeys = entry?.data.tags as string[];
const slugsArray = posts.map((post) => post.data.slug);

if (!slugsArray.includes(slug)) {
  return Astro.redirect(`/${language}/blog/`);
}

let tagsArray: TagTranslations[] = [];

tagKeys.forEach((tagName) => {
  (Object.keys(tags) as TagKey[]).forEach((tagNameInObject) => {
    if (tags[tagNameInObject][language] === tagName) {
      tagsArray.push(tags[tagNameInObject]);
    }
  });
});

if (!entry) {
  throw new Error("no entry");
}

if (!isStringLanguage(language)) {
  return new Response(null, { status: 404 });
}

const { Content } = await render(entry);
---

<RootLayout language={language}>
  <Prose>
    <a href=`/${language}/blog/` class="text-green2 dark:text-rosewater no-underline">to blog main page</a>
    <ul class="flex gap-4 p-0">
      {
        tagsArray.map((tag) => (
          <li class="flex list-none items-center justify-center border-4 p-1">
            <a href={`/${language}/tags/${tag["en"].toLowerCase()}`}>{tag[language]}</a>
          </li>
        ))
      }
    </ul>
    <Content />
  </Prose>
</RootLayout>
