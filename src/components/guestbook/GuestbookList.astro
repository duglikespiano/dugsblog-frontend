---
import { Icon } from "astro-icon/components";
import type { Messages } from "../../common/types";

const response = await fetch("http://localhost:8000/guestbook");
const fetchData = await response.json();
const messages: Messages[] = fetchData.data;
---

<div id="guestbook-list">
  <ul class="flex flex-col gap-y-8 pt-15">
    {
      messages.map((data) => (
        <li class="border-green2 dark:border-gray3 rounded-4xl border-4 p-6" data-message-id={data.id}>
          <div class="relative flex flex-col gap-4">
            <div class="flex items-center gap-2">
              <p class="text-green1 text-xl font-extrabold dark:text-gray-300">{data.name}</p>
              <p class="text-xs font-bold text-slate-700 opacity-80 dark:text-gray-400">
                {new Date(data.created_at).toLocaleDateString("en", {
                  year: "numeric",
                  month: "long",
                  day: "numeric",
                })}
              </p>
            </div>
            <p class="text-green2 dark:text-rosewater text-lg break-all">{data.message}</p>
            <Icon
              name="cil:trash"
              class="dark:text-gray3 absolute top-0 right-0 h-6 w-6 cursor-pointer text-slate-950"
              data-guestbook-delete-button
              data-messages-delete-id={data.id}
            />
          </div>
        </li>
      ))
    }
  </ul>
</div>

<script>
  import { isModalOpenStore } from "../../common/stores";
  import { deleteMessageIdStore } from "../../common/stores";

  let deleteMessageId: number | null;
  const guestbookDeleteButtons = document.querySelectorAll("[data-guestbook-delete-button]");
  guestbookDeleteButtons.forEach((button) => {
    button.addEventListener("click", (e) => {
      const target = e.target as HTMLElement;
      const messageId = target.dataset.messagesDeleteId;
      if (messageId) {
        deleteMessageIdStore.set(parseInt(messageId));
      }
      // const itemToHide = document.querySelector(`[data-message-id="${messageId}"]`) as HTMLElement;

      const previousStore = isModalOpenStore.get();
      isModalOpenStore.set({
        ...previousStore,
        "ask-password": true,
      });
    });
  });
</script>
